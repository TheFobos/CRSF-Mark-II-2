# Руководство по использованию API с телеметрией

## Архитектура

Система состоит из двух узлов:

1. **Управляющая машина (ведущий узел)**:
   - Запускает `crsf_api_server` (порт 8081)
   - Запускает GUI `crsf_realtime_interface.py --api`

2. **Управляемая машина (ведомый узел)**:
   - Запускает `crsf_io_rpi` (основное приложение)
   - Запускает `crsf_api_interpreter` (порт 8082)

## Запуск системы

### На управляемой машине (ведомый узел):

1. Запустите основное приложение:
```bash
./crsf_io_rpi
```

2. Запустите API интерпретатор:
```bash
./crsf_api_interpreter [порт] [адрес_API_сервера] [порт_API_сервера]
```

Пример:
```bash
./crsf_api_interpreter 8082 192.168.1.100 8081
```

Где:
- `8082` - порт интерпретатора (по умолчанию)
- `192.168.1.100` - IP адрес управляющей машины с API сервером
- `8081` - порт API сервера (по умолчанию)

### На управляющей машине (ведущий узел):

1. Запустите API сервер:
```bash
./crsf_api_server [порт] [адрес_ведомого_узла] [порт_интерпретатора]
```

Пример:
```bash
./crsf_api_server 8081 192.168.1.200 8082
```

Где:
- `8081` - порт API сервера (по умолчанию)
- `192.168.1.200` - IP адрес управляемой машины с интерпретатором
- `8082` - порт интерпретатора (по умолчанию)

2. Запустите GUI интерфейс:
```bash
python3 crsf_realtime_interface.py --api --api-url http://localhost:8081
```

## Как это работает

1. **Команды управления**:
   - GUI отправляет команды на API сервер (POST `/api/command/...`)
   - API сервер пересылает команды на интерпретатор ведомого узла
   - Интерпретатор записывает команды в `/tmp/crsf_command.txt`
   - Основное приложение читает команды и выполняет их

2. **Телеметрия**:
   - Основное приложение записывает телеметрию в `/tmp/crsf_telemetry.dat`
   - Интерпретатор читает телеметрию из файла каждые 20мс
   - Интерпретатор отправляет телеметрию на API сервер (POST `/api/telemetry`)
   - API сервер хранит последнюю телеметрию
   - GUI получает телеметрию через GET `/api/telemetry`

## Проверка работы

### Проверка API сервера:
```bash
curl http://localhost:8081/
```

### Проверка получения телеметрии:
```bash
curl http://localhost:8081/api/telemetry
```

### Проверка отправки команды:
```bash
curl -X POST http://localhost:8081/api/command/setChannel \
  -H "Content-Type: application/json" \
  -d '{"channel":1,"value":1500}'
```

## Требования

- Python 3.6+
- requests (pip install requests)
- tkinter (обычно входит в Python, на Linux может потребоваться `python3-tk`)
- Собранные бинарники: `crsf_api_server`, `crsf_api_interpreter`, `crsf_io_rpi`

## Установка зависимостей

```bash
pip install -r requirements.txt
```

На Linux для tkinter:
```bash
sudo apt-get install python3-tk
```
